# docker-compose-test.yml
# Isolated test environment for integration tests
# Uses different ports to avoid conflicts with development environment

name: backend-test

services:
  chronicle-backend-test:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev  # Use dev stage with test dependencies
    command: ["./start.sh"]
    ports:
      - "8001:8000"  # Avoid conflict with dev on 8000
    volumes:
      - ./src:/app/src  # Mount source code for easier development
      - ./data/test_audio_chunks:/app/audio_chunks
      - ./data/test_debug_dir:/app/debug  # Fixed: mount to /app/debug for plugin database
      - ./data/test_data:/app/data
      - ../../config:/app/config  # Mount config directory with defaults.yml
      - ../../tests/configs:/app/test-configs:ro  # Mount test-specific configs
      - ${PLUGINS_CONFIG:-../../tests/config/plugins.test.yml}:/app/config/plugins.yml  # Mount test plugins config to correct location
      - ../../plugins:/app/plugins  # External plugins directory
    environment:
      # Override with test-specific settings
      - MONGODB_URI=mongodb://mongo-test:27017/test_db
      - QDRANT_BASE_URL=qdrant-test
      - QDRANT_PORT=6333
      - REDIS_URL=redis://redis-test:6379/0
      - DEBUG_DIR=/app/debug  # Fixed: match plugin database mount path
      # Test configuration file
      - CONFIG_FILE=${TEST_CONFIG_FILE:-/app/test-configs/deepgram-openai.yml}
      # Import API keys from environment
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      # Authentication (test-specific)
      - AUTH_SECRET_KEY=test-jwt-signing-key-for-integration-tests
      - ADMIN_PASSWORD=test-admin-password-123
      - ADMIN_EMAIL=test-admin@example.com
      # Transcription provider configuration
      - TRANSCRIPTION_PROVIDER=${TRANSCRIPTION_PROVIDER:-deepgram}
      - PARAKEET_ASR_URL=${PARAKEET_ASR_URL}
      # Memory provider configuration
      - MEMORY_PROVIDER=${MEMORY_PROVIDER:-chronicle}
      - OPENMEMORY_MCP_URL=${OPENMEMORY_MCP_URL:-http://host.docker.internal:8765}
      - OPENMEMORY_USER_ID=${OPENMEMORY_USER_ID:-openmemory}
      # Speaker recognition controlled by config.yml (disabled in test config for CI performance)
      - SPEAKER_SERVICE_URL=http://speaker-service-test:8085
      - CORS_ORIGINS=http://localhost:3001,http://localhost:8001,https://localhost:3001,https://localhost:8001
      # Set inactivity timeout for tests (20 seconds of audio time)
      # This is audio duration, not wall-clock time
      - SPEECH_INACTIVITY_THRESHOLD_SECONDS=20
      # Set low speech detection thresholds for tests
      - SPEECH_DETECTION_MIN_DURATION=2.0  # 2 seconds instead of 10
      - SPEECH_DETECTION_MIN_WORDS=5  # 5 words instead of 10
      # Wait for audio queue to drain before timing out (test mode)
      - WAIT_FOR_AUDIO_QUEUE_DRAIN=true
      # Mock speaker recognition for tests (avoids resource-intensive ML service)
      # To test with REAL speaker recognition: set to 'false' and start extras/speaker-recognition service
      - USE_MOCK_SPEAKER_CLIENT=true
      # Langfuse observability (local test instance - prevents 12s DNS timeout per prompt fetch)
      - LANGFUSE_HOST=http://langfuse-web-test:3000
      - LANGFUSE_BASE_URL=http://langfuse-web-test:3000
      - LANGFUSE_PUBLIC_KEY=pk-lf-test-public-key
      - LANGFUSE_SECRET_KEY=sk-lf-test-secret-key
    depends_on:
      qdrant-test:
        condition: service_started
      mongo-test:
        condition: service_healthy
      redis-test:
        condition: service_started
      langfuse-web-test:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/readiness"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    restart: unless-stopped

  webui-test:
    build:
      context: ./webui
      dockerfile: Dockerfile
      args:
        - VITE_BACKEND_URL=http://localhost:8001
        - BACKEND_URL=http://localhost:8001
    volumes:
      - ./webui/src:/app/src  # Mount source code for easier development
    ports:
      - "3001:80"  # Avoid conflict with dev on 3000
    depends_on:
      chronicle-backend-test:
        condition: service_healthy
      mongo-test:
        condition: service_healthy
      qdrant-test:
        condition: service_started
      redis-test:
        condition: service_started

  qdrant-test:
    image: qdrant/qdrant:latest
    ports:
      - "6337:6333"  # gRPC - avoid conflict with dev 6333
      - "6338:6334"  # HTTP - avoid conflict with dev 6334
    volumes:
      - ./data/test_qdrant_data:/qdrant/storage

  mongo-test:
    image: mongo:8.0.14
    ports:
      - "27018:27017"  # Avoid conflict with dev on 27017
    volumes:
      - ./data/test_mongo_data:/data/db
    # Use test database name to ensure isolation
    command: mongod --dbpath /data/db --bind_ip_all
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.runCommand('ping').ok", "--quiet"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  redis-test:
    image: redis:7-alpine
    ports:
      - "6380:6379"  # Avoid conflict with dev on 6379
    volumes:
      - ./data/test_redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  speaker-service-test:
    build:
      context: ../../extras/speaker-recognition
      dockerfile: Dockerfile
      args:
        PYTORCH_CUDA_VERSION: cu12.6
    image: speaker-recognition-test:latest
    ports:
      - "8086:8085"  # Avoid conflict with dev speaker service on 8085
    volumes:
      - ../../extras/speaker-recognition/src:/app/src
      - ../../extras/speaker-recognition/model_cache:/models
      - ../../extras/speaker-recognition/audio_chunks:/app/audio_chunks
      - ../../extras/speaker-recognition/debug:/app/debug
      - ../../extras/speaker-recognition/speaker_data:/app/data
    environment:
      - HF_HOME=/models
      - HF_TOKEN=${HF_TOKEN}
      - SIMILARITY_THRESHOLD=0.15
      - SPEAKER_SERVICE_HOST=0.0.0.0
      - SPEAKER_SERVICE_PORT=8085
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    profiles:
      - speaker  # Optional service - only start when explicitly enabled

  mock-streaming-stt:
    build:
      context: ../..
      dockerfile: tests/Dockerfile.mock-streaming-stt
    ports:
      - "9999:9999"
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.socket(); s.connect(('localhost',9999)); s.close()"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  mock-llm:
    build:
      context: ../..
      dockerfile: tests/Dockerfile.mock-llm
    ports:
      - "11435:11435"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:11435/health').read()"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  mock-asr:
    build:
      context: ../..
      dockerfile: tests/Dockerfile.mock-asr
    ports:
      - "8765:8765"
    environment:
      # Provider mode for mock ASR: mock, parakeet, vibevoice, deepgram
      # vibevoice mode returns diarized segments with speaker labels
      MOCK_ASR_PROVIDER: ${MOCK_ASR_PROVIDER:-mock}
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8765/health').read()"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # --- Langfuse observability stack (test) ---
  # Without this, Langfuse SDK defaults to cloud.langfuse.com and each
  # get_prompt() call blocks ~12s on DNS timeout, adding ~39s to title/summary jobs.
  langfuse-postgres-test:
    image: docker.io/postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    volumes:
      - ./data/test_langfuse_postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 3s
      timeout: 3s
      retries: 10

  clickhouse-test:
    image: docker.io/clickhouse/clickhouse-server:24.12
    restart: unless-stopped
    environment:
      CLICKHOUSE_DB: default
      CLICKHOUSE_USER: clickhouse
      CLICKHOUSE_PASSWORD: clickhouse
    volumes:
      - clickhouse_test_data:/var/lib/clickhouse
      - clickhouse_test_logs:/var/log/clickhouse-server
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:8123/ping || exit 1
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 1s

  minio-test:
    image: docker.io/minio/minio:RELEASE.2025-01-20T14-49-07Z
    restart: unless-stopped
    entrypoint: sh
    command: -c 'mkdir -p /data/langfuse && minio server --address ":9000" --console-address ":9001" /data'
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: miniosecret
    volumes:
      - ./data/test_langfuse_minio:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 1s
      timeout: 5s
      retries: 5
      start_period: 1s

  langfuse-redis-test:
    image: docker.io/redis:7
    restart: unless-stopped
    command: >
      --requirepass myredissecret
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "myredissecret", "ping"]
      interval: 3s
      timeout: 10s
      retries: 10

  langfuse-worker-test:
    image: docker.io/langfuse/langfuse-worker:3
    restart: unless-stopped
    depends_on:
      langfuse-postgres-test:
        condition: service_healthy
      minio-test:
        condition: service_healthy
      langfuse-redis-test:
        condition: service_healthy
      clickhouse-test:
        condition: service_healthy
    environment: &langfuse-test-env
      DATABASE_URL: postgresql://postgres:postgres@langfuse-postgres-test:5432/postgres
      NEXTAUTH_URL: http://0.0.0.0:3000
      SALT: "0000000000000000000000000000000000000000000000000000000000000000"
      ENCRYPTION_KEY: "0000000000000000000000000000000000000000000000000000000000000000"
      TELEMETRY_ENABLED: "false"
      LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES: "true"
      CLICKHOUSE_MIGRATION_URL: clickhouse://clickhouse-test:9000
      CLICKHOUSE_URL: http://clickhouse-test:8123
      CLICKHOUSE_USER: clickhouse
      CLICKHOUSE_PASSWORD: clickhouse
      CLICKHOUSE_CLUSTER_ENABLED: "false"
      LANGFUSE_S3_EVENT_UPLOAD_BUCKET: langfuse
      LANGFUSE_S3_EVENT_UPLOAD_REGION: auto
      LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID: minio
      LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY: miniosecret
      LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT: http://minio-test:9000
      LANGFUSE_S3_EVENT_UPLOAD_FORCE_PATH_STYLE: "true"
      LANGFUSE_S3_EVENT_UPLOAD_PREFIX: "events/"
      LANGFUSE_S3_MEDIA_UPLOAD_BUCKET: langfuse
      LANGFUSE_S3_MEDIA_UPLOAD_REGION: auto
      LANGFUSE_S3_MEDIA_UPLOAD_ACCESS_KEY_ID: minio
      LANGFUSE_S3_MEDIA_UPLOAD_SECRET_ACCESS_KEY: miniosecret
      LANGFUSE_S3_MEDIA_UPLOAD_ENDPOINT: http://minio-test:9000
      LANGFUSE_S3_MEDIA_UPLOAD_FORCE_PATH_STYLE: "true"
      LANGFUSE_S3_MEDIA_UPLOAD_PREFIX: "media/"
      LANGFUSE_S3_BATCH_EXPORT_ENABLED: "false"
      REDIS_HOST: langfuse-redis-test
      REDIS_PORT: "6379"
      REDIS_AUTH: myredissecret
      REDIS_TLS_ENABLED: "false"

  langfuse-web-test:
    image: docker.io/langfuse/langfuse:3
    restart: unless-stopped
    depends_on:
      langfuse-postgres-test:
        condition: service_healthy
      minio-test:
        condition: service_healthy
      langfuse-redis-test:
        condition: service_healthy
      clickhouse-test:
        condition: service_healthy
    environment:
      <<: *langfuse-test-env
      HOSTNAME: "0.0.0.0"
      NEXTAUTH_SECRET: "test-nextauth-secret-for-langfuse"
      # Auto-seed org/project with deterministic API keys (no manual setup)
      LANGFUSE_INIT_ORG_ID: "test-org"
      LANGFUSE_INIT_ORG_NAME: "Test Organization"
      LANGFUSE_INIT_PROJECT_ID: "test-project"
      LANGFUSE_INIT_PROJECT_NAME: "Test Project"
      LANGFUSE_INIT_PROJECT_PUBLIC_KEY: "pk-lf-test-public-key"
      LANGFUSE_INIT_PROJECT_SECRET_KEY: "sk-lf-test-secret-key"
      LANGFUSE_INIT_USER_EMAIL: "test@example.com"
      LANGFUSE_INIT_USER_NAME: "Test User"
      LANGFUSE_INIT_USER_PASSWORD: "test-password"
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://$(hostname):3000/api/public/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 120s

  workers-test:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev  # Use dev stage with test dependencies
    command: ["python", "worker_orchestrator.py"]
    volumes:
      - ./src:/app/src
      - ./worker_orchestrator.py:/app/worker_orchestrator.py
      - ./data/test_audio_chunks:/app/audio_chunks
      - ./data/test_debug_dir:/app/debug  # Fixed: mount to /app/debug for plugin database
      - ./data/test_data:/app/data
      - ../../config:/app/config  # Mount config directory with defaults.yml
      - ../../tests/configs:/app/test-configs:ro  # Mount test-specific configs
      - ${PLUGINS_CONFIG:-../../tests/config/plugins.test.yml}:/app/config/plugins.yml  # Mount test plugins config to correct location
      - ../../plugins:/app/plugins  # External plugins directory
    environment:
      # Same environment as backend
      - MONGODB_URI=mongodb://mongo-test:27017/test_db
      - QDRANT_BASE_URL=qdrant-test
      - QDRANT_PORT=6333
      - REDIS_URL=redis://redis-test:6379/0
      - DEBUG_DIR=/app/debug  # Fixed: match plugin database mount path
      # Test configuration file
      - CONFIG_FILE=${TEST_CONFIG_FILE:-/app/test-configs/deepgram-openai.yml}
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - AUTH_SECRET_KEY=test-jwt-signing-key-for-integration-tests
      - ADMIN_PASSWORD=test-admin-password-123
      - ADMIN_EMAIL=test-admin@example.com
      - TRANSCRIPTION_PROVIDER=${TRANSCRIPTION_PROVIDER:-deepgram}
      - PARAKEET_ASR_URL=${PARAKEET_ASR_URL}
      - MEMORY_PROVIDER=${MEMORY_PROVIDER:-chronicle}
      - OPENMEMORY_MCP_URL=${OPENMEMORY_MCP_URL:-http://host.docker.internal:8765}
      - OPENMEMORY_USER_ID=${OPENMEMORY_USER_ID:-openmemory}
      # Speaker recognition controlled by config.yml (disabled in test config for CI performance)
      - SPEAKER_SERVICE_URL=http://speaker-service-test:8085
      # Set inactivity timeout for tests (20 seconds of audio time)
      # This is audio duration, not wall-clock time
      - SPEECH_INACTIVITY_THRESHOLD_SECONDS=20
      # Set low speech detection thresholds for tests
      - SPEECH_DETECTION_MIN_DURATION=2.0  # 2 seconds instead of 10
      - SPEECH_DETECTION_MIN_WORDS=5  # 5 words instead of 10
      # Wait for audio queue to drain before timing out (test mode)
      - WAIT_FOR_AUDIO_QUEUE_DRAIN=true
      # Mock speaker recognition for tests (avoids resource-intensive ML service)
      # To test with REAL speaker recognition: set to 'false' and start extras/speaker-recognition service
      - USE_MOCK_SPEAKER_CLIENT=true
      # Langfuse observability (local test instance - prevents 12s DNS timeout per prompt fetch)
      - LANGFUSE_HOST=http://langfuse-web-test:3000
      - LANGFUSE_BASE_URL=http://langfuse-web-test:3000
      - LANGFUSE_PUBLIC_KEY=pk-lf-test-public-key
      - LANGFUSE_SECRET_KEY=sk-lf-test-secret-key
    depends_on:
      chronicle-backend-test:
        condition: service_healthy
      mongo-test:
        condition: service_healthy
      redis-test:
        condition: service_started
      qdrant-test:
        condition: service_started
    restart: unless-stopped

  # caddy:
  #   image: caddy:2-alpine
  #   ports:
  #     - "443:443"
  #     - "80:80"  # HTTP redirect to HTTPS
  #   volumes:
  #     - ./Caddyfile-test:/etc/caddy/Caddyfile:ro
  #     - ./data/caddy_data:/data
  #     - ./data/caddy_config:/config
  #   depends_on:
  #     webui-test:
  #       condition: service_started
  #     chronicle-backend-test:
  #       condition: service_healthy
  #   restart: unless-stopped

# Named volumes for Langfuse services (avoids bind-mount permission issues with ClickHouse user 101:101)
volumes:
  clickhouse_test_data:
  clickhouse_test_logs:

# Use default bridge network for test isolation (no external network dependency)
networks:
  default:
    driver: bridge

# CI Considerations (for future implementation):
# - GitHub Actions can run these services in isolated containers
# - Port conflicts won't exist in CI since each job runs in isolation
# - For CI, we could add:
#   - --build flag for fresh builds
#   - --force-recreate for clean state
#   - Volume cleanup between test runs
# - Environment variables can be injected via GitHub secrets
# - Health checks ensure services are ready before tests run
