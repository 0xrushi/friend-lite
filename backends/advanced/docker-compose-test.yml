# docker-compose-test.yml
# Isolated test environment for integration tests
# Uses different ports to avoid conflicts with development environment

name: backend-test

services:
  chronicle-backend-test:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev  # Use dev stage with test dependencies
    command: ["./start.sh"]
    ports:
      - "8001:8000"  # Avoid conflict with dev on 8000
    volumes:
      - ./src:/app/src  # Mount source code for easier development
      - ./data/test_audio_chunks:/app/audio_chunks
      - ./data/test_debug_dir:/app/debug  # Fixed: mount to /app/debug for plugin database
      - ./data/test_data:/app/data
      - ../../config:/app/config  # Mount config directory with defaults.yml
      - ../../tests/configs:/app/test-configs:ro  # Mount test-specific configs
      - ${PLUGINS_CONFIG:-../../tests/config/plugins.test.yml}:/app/config/plugins.yml  # Mount test plugins config to correct location
      - ../../plugins:/app/plugins  # External plugins directory
    environment:
      # Override with test-specific settings
      - MONGODB_URI=mongodb://mongo-test:27017/test_db
      - QDRANT_BASE_URL=qdrant-test
      - QDRANT_PORT=6333
      - REDIS_URL=redis://redis-test:6379/0
      - DEBUG_DIR=/app/debug  # Fixed: match plugin database mount path
      # Test configuration file
      - CONFIG_FILE=${TEST_CONFIG_FILE:-/app/test-configs/deepgram-openai.yml}
      # Import API keys from environment
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      # Authentication (test-specific)
      - AUTH_SECRET_KEY=test-jwt-signing-key-for-integration-tests
      - ADMIN_PASSWORD=test-admin-password-123
      - ADMIN_EMAIL=test-admin@example.com
      # Transcription provider configuration
      - TRANSCRIPTION_PROVIDER=${TRANSCRIPTION_PROVIDER:-deepgram}
      - PARAKEET_ASR_URL=${PARAKEET_ASR_URL}
      # Memory provider configuration
      - MEMORY_PROVIDER=${MEMORY_PROVIDER:-chronicle}
      - OPENMEMORY_MCP_URL=${OPENMEMORY_MCP_URL:-http://host.docker.internal:8765}
      - OPENMEMORY_USER_ID=${OPENMEMORY_USER_ID:-openmemory}
      # Speaker recognition controlled by config.yml (disabled in test config for CI performance)
      - SPEAKER_SERVICE_URL=http://speaker-service-test:8085
      - CORS_ORIGINS=http://localhost:3001,http://localhost:8001,https://localhost:3001,https://localhost:8001
      # Set inactivity timeout for tests (20 seconds of audio time)
      # This is audio duration, not wall-clock time
      - SPEECH_INACTIVITY_THRESHOLD_SECONDS=20
      # Set low speech detection thresholds for tests
      - SPEECH_DETECTION_MIN_DURATION=2.0  # 2 seconds instead of 10
      - SPEECH_DETECTION_MIN_WORDS=5  # 5 words instead of 10
      # Wait for audio queue to drain before timing out (test mode)
      - WAIT_FOR_AUDIO_QUEUE_DRAIN=true
      # Mock speaker recognition for tests (avoids resource-intensive ML service)
      # To test with REAL speaker recognition: set to 'false' and start extras/speaker-recognition service
      - USE_MOCK_SPEAKER_CLIENT=true
    depends_on:
      qdrant-test:
        condition: service_started
      mongo-test:
        condition: service_healthy
      redis-test:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/readiness"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    restart: unless-stopped

  webui-test:
    build:
      context: ./webui
      dockerfile: Dockerfile
      args:
        - VITE_BACKEND_URL=http://localhost:8001
        - BACKEND_URL=http://localhost:8001
    volumes:
      - ./webui/src:/app/src  # Mount source code for easier development
    ports:
      - "3001:80"  # Avoid conflict with dev on 3000
    depends_on:
      chronicle-backend-test:
        condition: service_healthy
      mongo-test:
        condition: service_healthy
      qdrant-test:
        condition: service_started
      redis-test:
        condition: service_started

  qdrant-test:
    image: qdrant/qdrant:latest
    ports:
      - "6337:6333"  # gRPC - avoid conflict with dev 6333
      - "6338:6334"  # HTTP - avoid conflict with dev 6334
    volumes:
      - ./data/test_qdrant_data:/qdrant/storage

  mongo-test:
    image: mongo:8.0.14
    ports:
      - "27018:27017"  # Avoid conflict with dev on 27017
    volumes:
      - ./data/test_mongo_data:/data/db
    # Use test database name to ensure isolation
    command: mongod --dbpath /data/db --bind_ip_all
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.runCommand('ping').ok", "--quiet"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  redis-test:
    image: redis:7-alpine
    ports:
      - "6380:6379"  # Avoid conflict with dev on 6379
    volumes:
      - ./data/test_redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  speaker-service-test:
    build:
      context: ../../extras/speaker-recognition
      dockerfile: Dockerfile
      args:
        PYTORCH_CUDA_VERSION: cu12.6
    image: speaker-recognition-test:latest
    ports:
      - "8086:8085"  # Avoid conflict with dev speaker service on 8085
    volumes:
      - ../../extras/speaker-recognition/src:/app/src
      - ../../extras/speaker-recognition/model_cache:/models
      - ../../extras/speaker-recognition/audio_chunks:/app/audio_chunks
      - ../../extras/speaker-recognition/debug:/app/debug
      - ../../extras/speaker-recognition/speaker_data:/app/data
    environment:
      - HF_HOME=/models
      - HF_TOKEN=${HF_TOKEN}
      - SIMILARITY_THRESHOLD=0.15
      - SPEAKER_SERVICE_HOST=0.0.0.0
      - SPEAKER_SERVICE_PORT=8085
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    profiles:
      - speaker  # Optional service - only start when explicitly enabled

  mock-streaming-stt:
    build:
      context: ../..
      dockerfile: tests/Dockerfile.mock-streaming-stt
    ports:
      - "9999:9999"
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.socket(); s.connect(('localhost',9999)); s.close()"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  mock-llm:
    build:
      context: ../..
      dockerfile: tests/Dockerfile.mock-llm
    ports:
      - "11435:11435"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:11435/health').read()"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  mock-asr:
    build:
      context: ../..
      dockerfile: tests/Dockerfile.mock-asr
    ports:
      - "8765:8765"
    environment:
      # Provider mode for mock ASR: mock, parakeet, vibevoice, deepgram
      # vibevoice mode returns diarized segments with speaker labels
      MOCK_ASR_PROVIDER: ${MOCK_ASR_PROVIDER:-mock}
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8765/health').read()"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  workers-test:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev  # Use dev stage with test dependencies
    command: ["python", "worker_orchestrator.py"]
    volumes:
      - ./src:/app/src
      - ./worker_orchestrator.py:/app/worker_orchestrator.py
      - ./data/test_audio_chunks:/app/audio_chunks
      - ./data/test_debug_dir:/app/debug  # Fixed: mount to /app/debug for plugin database
      - ./data/test_data:/app/data
      - ../../config:/app/config  # Mount config directory with defaults.yml
      - ../../tests/configs:/app/test-configs:ro  # Mount test-specific configs
      - ${PLUGINS_CONFIG:-../../tests/config/plugins.test.yml}:/app/config/plugins.yml  # Mount test plugins config to correct location
      - ../../plugins:/app/plugins  # External plugins directory
    environment:
      # Same environment as backend
      - MONGODB_URI=mongodb://mongo-test:27017/test_db
      - QDRANT_BASE_URL=qdrant-test
      - QDRANT_PORT=6333
      - REDIS_URL=redis://redis-test:6379/0
      - DEBUG_DIR=/app/debug  # Fixed: match plugin database mount path
      # Test configuration file
      - CONFIG_FILE=${TEST_CONFIG_FILE:-/app/test-configs/deepgram-openai.yml}
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - AUTH_SECRET_KEY=test-jwt-signing-key-for-integration-tests
      - ADMIN_PASSWORD=test-admin-password-123
      - ADMIN_EMAIL=test-admin@example.com
      - TRANSCRIPTION_PROVIDER=${TRANSCRIPTION_PROVIDER:-deepgram}
      - PARAKEET_ASR_URL=${PARAKEET_ASR_URL}
      - MEMORY_PROVIDER=${MEMORY_PROVIDER:-chronicle}
      - OPENMEMORY_MCP_URL=${OPENMEMORY_MCP_URL:-http://host.docker.internal:8765}
      - OPENMEMORY_USER_ID=${OPENMEMORY_USER_ID:-openmemory}
      # Speaker recognition controlled by config.yml (disabled in test config for CI performance)
      - SPEAKER_SERVICE_URL=http://speaker-service-test:8085
      # Set inactivity timeout for tests (20 seconds of audio time)
      # This is audio duration, not wall-clock time
      - SPEECH_INACTIVITY_THRESHOLD_SECONDS=20
      # Set low speech detection thresholds for tests
      - SPEECH_DETECTION_MIN_DURATION=2.0  # 2 seconds instead of 10
      - SPEECH_DETECTION_MIN_WORDS=5  # 5 words instead of 10
      # Wait for audio queue to drain before timing out (test mode)
      - WAIT_FOR_AUDIO_QUEUE_DRAIN=true
      # Mock speaker recognition for tests (avoids resource-intensive ML service)
      # To test with REAL speaker recognition: set to 'false' and start extras/speaker-recognition service
      - USE_MOCK_SPEAKER_CLIENT=true
    depends_on:
      chronicle-backend-test:
        condition: service_healthy
      mongo-test:
        condition: service_healthy
      redis-test:
        condition: service_started
      qdrant-test:
        condition: service_started
    restart: unless-stopped

  # caddy:
  #   image: caddy:2-alpine
  #   ports:
  #     - "443:443"
  #     - "80:80"  # HTTP redirect to HTTPS
  #   volumes:
  #     - ./Caddyfile-test:/etc/caddy/Caddyfile:ro
  #     - ./data/caddy_data:/data
  #     - ./data/caddy_config:/config
  #   depends_on:
  #     webui-test:
  #       condition: service_started
  #     chronicle-backend-test:
  #       condition: service_healthy
  #   restart: unless-stopped

# Use default bridge network for test isolation (no external network dependency)
networks:
  default:
    driver: bridge

# CI Considerations (for future implementation):
# - GitHub Actions can run these services in isolated containers
# - Port conflicts won't exist in CI since each job runs in isolation
# - For CI, we could add:
#   - --build flag for fresh builds
#   - --force-recreate for clean state
#   - Volume cleanup between test runs
# - Environment variables can be injected via GitHub secrets
# - Health checks ensure services are ready before tests run
