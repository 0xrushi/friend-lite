FROM docker.io/kyuz0/vllm-therock-gfx1151:sha-039484a

ARG PYTORCH_CUDA_VERSION=strixhalo
ENV PYTORCH_CUDA_VERSION=${PYTORCH_CUDA_VERSION}

# Install system dependencies (base image may be deb/rpm/alpine)
RUN set -eux; \
    if command -v apt-get >/dev/null 2>&1; then \
        apt-get update; \
        apt-get install -y --no-install-recommends \
            build-essential git ffmpeg curl libjpeg-dev zlib1g-dev libpng-dev; \
        rm -rf /var/lib/apt/lists/*; \
    elif command -v dnf >/dev/null 2>&1; then \
        dnf -y install \
            gcc gcc-c++ make git ffmpeg curl libjpeg-turbo-devel zlib-devel libpng-devel; \
        dnf -y clean all; \
    elif command -v yum >/dev/null 2>&1; then \
        yum -y install \
            gcc gcc-c++ make git ffmpeg curl libjpeg-turbo-devel zlib-devel libpng-devel; \
        yum -y clean all; \
    elif command -v apk >/dev/null 2>&1; then \
        apk add --no-cache \
            build-base git ffmpeg curl jpeg-dev zlib-dev libpng-dev; \
    else \
        echo "WARNING: No supported package manager found; skipping OS deps install" >&2; \
    fi

WORKDIR /app

# Install uv
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

# Copy dependency files first (for better caching)
COPY pyproject.toml uv.lock ./

# Use the base image's prebuilt venv (contains torch stack for gfx1151)
RUN test -x /opt/venv/bin/python
ENV VIRTUAL_ENV=/opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Install dependencies, but never install/override torch/torchvision/torchaudio in this image.
# We avoid `uv sync` here because it recreates the venv and drops `--system-site-packages`.
# For strixhalo, we install pyannote.audio from git with --no-deps separately.
RUN set -eux; \
    uv export --frozen --format requirements.txt --no-dev --no-hashes \
        --extra ${PYTORCH_CUDA_VERSION} --no-emit-project \
        --prune torch --prune torchvision --prune torchaudio \
        --prune rocm --prune rocm-sdk-core --prune rocm-sdk-devel --prune rocm-sdk-libraries-gfx1151 \
        --prune torchcodec \
        $(if [ "${PYTORCH_CUDA_VERSION}" = "strixhalo" ]; then echo "--prune pyannote.audio"; fi) \
        --output-file /tmp/requirements.txt; \
    uv pip install --python /opt/venv/bin/python --no-managed-python --prerelease=if-necessary-or-explicit \
        --requirements /tmp/requirements.txt; \
    if [ "${PYTORCH_CUDA_VERSION}" = "strixhalo" ]; then \
        uv pip install --python /opt/venv/bin/python --no-managed-python --no-deps \
            "git+https://github.com/pyannote/pyannote-audio.git"; \
    fi; \
    uv cache clean

# Copy the full source code (after dependencies are cached)
COPY src/ src/

# Install the project (editable so the compose bind-mount workflow still works)
RUN uv pip install --python /opt/venv/bin/python --no-managed-python --no-deps --editable .

# Verify we can import the base image's torch stack (and that torchvision ops are present)
RUN python -c "import torch, torchvision; print('torch', torch.__version__, torch.__file__); print('torchvision', torchvision.__version__, torchvision.__file__)"

# Create directories
RUN mkdir -p /app/audio_chunks /app/debug /app/data /models

# Set environment variables
ENV HF_HOME=/models
ENV PYTHONPATH=/app
ENV LD_LIBRARY_PATH=/opt/rocm/lib:/opt/rocm/lib/host-math/lib:/opt/rocm/lib/rocm_sysdeps/lib:/opt/venv/lib/python3.13/site-packages/torch/lib:/usr/lib64:${LD_LIBRARY_PATH}

# Expose port
EXPOSE 8085

# Run the service
CMD ["/opt/venv/bin/simple-speaker-service"]
