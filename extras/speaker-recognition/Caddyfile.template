# Caddy reverse proxy for Chronicle Speaker Recognition
# Provides unified HTTPS endpoint for API and Web UI

localhost TAILSCALE_IP {
    tls /certs/server.crt /certs/server.key

    # Speaker Service API endpoints (strip /api prefix)
    handle /api/* {
        uri strip_prefix /api
        reverse_proxy speaker-service:8085
    }

    # WebSocket endpoints
    handle /ws/* {
        reverse_proxy speaker-service:8085
    }

    # Deepgram-compatible WebSocket endpoints
    handle /v1/* {
        reverse_proxy speaker-service:8085
    }

    # Health check endpoint
    handle /health {
        reverse_proxy speaker-service:8085
    }

    # Everything else - proxy to Web UI
    handle {
        reverse_proxy web-ui:WEB_UI_PORT_PLACEHOLDER {
            transport http {
                tls_insecure_skip_verify
            }
        }
    }
}
