FROM python:3.12-bookworm AS builder

# Install system dependencies including PortAudio for pyaudio
RUN apt-get update && apt-get install -y \
    build-essential \
    git \
    ffmpeg \
    curl \
    && rm -rf /var/lib/apt/lists/*
    # portaudio19-dev \
    # libasound2-dev \

WORKDIR /app

# Install uv
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

# Copy dependency files first (for better caching)
COPY pyproject.toml ./

# Create minimal package structure for dependency installation
RUN mkdir -p src/simple_speaker_recognition
COPY src/simple_speaker_recognition/__init__.py src/simple_speaker_recognition/

# Install dependencies and package  
# Use build arg to control CPU vs GPU mode
ARG COMPUTE_MODE=cpu
ARG CUDA_VERSION
RUN if [ "$COMPUTE_MODE" = "gpu" ]; then \
        uv pip install --system ".[${CUDA_VERSION}]" -f https://download.pytorch.org/whl/${CUDA_VERSION}; \
    else \
        uv pip install --system ".[cpu]" -f https://download.pytorch.org/whl/cpu; \
    fi

# Create directories
RUN mkdir -p /app/audio_chunks /app/debug /app/data /models

# Set environment variables
ENV HF_HOME=/models
ENV PATH="/app/.venv/bin:$PATH"

# Expose port
EXPOSE 8085

# Run the service
CMD ["python", "-m", "simple_speaker_recognition"]
