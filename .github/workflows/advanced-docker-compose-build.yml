name: Build and Deploy Advanced (Docker Compose)

on:
  workflow_dispatch:
    inputs:
      version:
        description: Optional version tag override (e.g. v1.2.3)
        required: false
  push:
    branches: [ "main", "feat/*" ]
    paths:
      - "*"
      - "backends/advanced/**"
      - ".github/workflows/advanced-docker-compose-build.yml"
    tags:
      - "v*"


permissions:
  contents: read
  packages: write
  actions: read

env:
  REGISTRY: ghcr.io

jobs:
  build-self-hosted:
    runs-on: [self-hosted, linux, x64]
    timeout-minutes: 60
    continue-on-error: true
    env:
      ADVANCED_ENV: ${{ secrets.ADVANCED_ENV }}
      RUNNER_FLAVOUR: self-hosted
    defaults:
      run:
        shell: bash
        working-directory: backends/advanced

    steps: &advanced_build_steps
      - name: Show selected runner
        run: echo "Workflow running on ${RUNNER_FLAVOUR} runner"
        working-directory: .

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Copy .env.template to .env
        run: |
          set -euo pipefail
          copy_env() {
            local dir="$1"
            local template="${dir}/.env.template"
            local target="${dir}/.env"
            if [ -f "$template" ]; then
              echo "Copying $template to $target"
              cp "$template" "$target"
            else
              echo "$template not found; skipping"
            fi
          }

          copy_env .
          copy_env ../../extras/asr-services
          copy_env ../../extras/speaker-recognition

      - name: Create .env from secret (if provided)
        if: env.ADVANCED_ENV != ''
        run: |
          echo "Writing .env from ADVANCED_ENV secret"
          printf "%s\n" "${ADVANCED_ENV}" > .env

      - name: Source .env (if present)
        run: |
          if [ -f .env ]; then
            set -a
            # shellcheck disable=SC1091
            source .env
            set +a
          else
            echo ".env not found; continuing"
          fi

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [ "${{ github.ref_type }}" = "tag" ]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="sha-${GITHUB_SHA::7}"
          fi
          echo "VERSION=$VERSION" | tee -a "$GITHUB_OUTPUT"

      - name: Build, push, and prune services sequentially
        env:
          OWNER: ${{ github.repository_owner }}
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          set -euo pipefail
          docker compose version
          OWNER_LC=$(echo "$OWNER" | tr '[:upper:]' '[:lower:]')
          # Only services with local Dockerfiles (skip redis/mongo/qdrant/caddy etc.)
          # Advanced project builds use the "advanced-" prefix; extras use explicit names
          services=("advanced-friend-backend" "advanced-workers" "advanced-webui" "parakeet-asr" "speaker-recognition")
          service_names=("friend-backend" "workers" "webui" "parakeet-asr" "speaker-recognition")

          for i in "${!services[@]}"; do
            svc="${services[$i]}"
            svc_name="${service_names[$i]}"

            echo "::group::Building $svc_name"
            case "$svc" in
              advanced-friend-backend|advanced-workers|advanced-webui)
                docker compose build --pull "$svc"
                ;;
              parakeet-asr)
                docker compose -f ../../extras/asr-services/docker-compose.yml --project-directory ../../extras/asr-services build parakeet-asr
                ;;
              speaker-recognition)
                docker compose -f ../../extras/speaker-recognition/docker-compose.yml --project-directory ../../extras/speaker-recognition build speaker-service
                ;;
              *)
                echo "Unknown service '$svc'; aborting."
                exit 1
                ;;
            esac

            img_id=$(docker images --format "{{.Repository}} {{.Tag}} {{.ID}}" | awk -v repo="$svc" '$1 == repo {print $3; exit}')
            if [ -z "${img_id:-}" ]; then
              echo "Skipping $svc_name (no built image found after build)"
              echo "::endgroup::"
              continue
            fi

            target_image="$REGISTRY/$OWNER_LC/$svc_name:$VERSION"
            echo "Tagging $img_id as $target_image"
            docker tag "$img_id" "$target_image"

            echo "Pushing $target_image"
            docker push "$target_image"
            echo "Removing local image tags for $svc_name"
            docker image rm -f "$target_image" || true
            docker image rm -f "$img_id" || true
            echo "Pruning Docker builder cache and unused data"
            docker builder prune -af || true
            docker system prune -af || true
            echo "::endgroup::"
          done

  build-default:
    needs: build-self-hosted
    if: needs.build-self-hosted.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      ADVANCED_ENV: ${{ secrets.ADVANCED_ENV }}
      RUNNER_FLAVOUR: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: backends/advanced
    steps: *advanced_build_steps
